# -*- mode: ruby -*-
# vi: set ft=ruby :
## vagrant plugins required:
# vagrant-digitalocean, vagrant, vagrant-hosts, vagrant-cachier
Vagrant.configure("2") do |config|

  # https://vagrantcloud.com/puppetlabs/boxes/ubuntu-14.04-64-puppet
  config.vm.box = "puppetlabs/ubuntu-14.04-64-puppet"

  # If you want to use vagrant-cachier,
  # please install vagrant-cachier plugin.
  if Vagrant.has_plugin?("vagrant-cachier")
    config.cache.enable :apt
  end

  config.vm.provider :virtualbox do |vb, override|
    # Use VBoxManage to customize the VM. For example to change memory:
    vb.customize ["modifyvm", :id, "--memory", "#{1024*2}"]
    vb.customize ["modifyvm", :id,  "--cpus",  "2"]

    # Please customize hostname and private ip configuration if you needed.
    override.vm.hostname = "mesos"
    private_ip = "192.168.33.10"
    override.vm.network :private_network, ip: private_ip
    override.vm.provision :hosts do |provisioner|
      provisioner.add_host private_ip , [ config.vm.hostname ]
    end

    # for mesos web UI.
    override.vm.network :forwarded_port, guest: 5050, host: 5050
    # for Marathon web UI
    override.vm.network :forwarded_port, guest: 8080, host: 8080

    override.vm.provision :shell do |s|
      s.path = "scripts/populate_sshkey.sh"
      s.args = "/home/vagrant vagrant"
    end
  end

  config.vm.provision "puppet" do |puppet|
    puppet.manifests_path    = "manifests"
    puppet.module_path       = "../modules"
    puppet.manifest_file     = "default.pp"
    puppet.hiera_config_path = "../hiera.yaml"
    puppet.options           = "--verbose --debug"
  end

  # If you wanted use `.dockercfg` file
  # Please place the file simply on this directory
  if File.exist?(".dockercfg")
    config.vm.provision :shell, :priviledged => true, :inline => <<-SCRIPT
      cp /vagrant/.dockercfg /root/.dockercfg
      chmod 600 /root/.dockercfg
      chown root /root/.dockercfg
      SCRIPT
  end
end
